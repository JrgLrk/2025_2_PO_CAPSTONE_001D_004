{% extends 'base.html' %}

{% block content %}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card mt-4">
                <div class="card-header">
                    <h3>Solicitud de Atención de Vehículo</h3>
                </div>
                <div class="card-body">
                    <form method="post" id="solicitudForm" novalidate>
                        {% csrf_token %}
                        {{ form.agenda_slot }} {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %} <p>{{ error }}</p> {% endfor %}
                            </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.vehiculo.id_for_label }}" class="form-label">{{ form.vehiculo.label }}</label>
                            {{ form.vehiculo }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.motivo_ingreso.id_for_label }}" class="form-label">{{ form.motivo_ingreso.label }}</label>
                            {{ form.motivo_ingreso }}
                        </div>
                        <hr>
                        
                        <div class="mb-3">
                            <label class="form-label">Seleccione un Horario de Cita</label>
                            
                            {% if form.agenda_slot.errors %}
                                <div class="alert alert-danger py-2">
                                    Por favor, seleccione un horario de la lista.
                                </div>
                            {% endif %}
                            
                            {% regroup slots_disponibles|dictsort:"tipo_atencion" by get_tipo_atencion_display as tipos_de_atencion %}
                            
                            <div class="accordion" id="accordionTipos">
                                {% for tipo in tipos_de_atencion %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading-{{ tipo.grouper|slugify }}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ tipo.grouper|slugify }}">
                                            <strong>{{ tipo.grouper }}</strong> 
                                            <span class="badge bg-secondary ms-2">{{ tipo.list|length }} disponible(s)</span>
                                        </button>
                                    </h2>
                                    <div id="collapse-{{ tipo.grouper|slugify }}" class="accordion-collapse collapse" data-bs-parent="#accordionTipos">
                                        <div class="accordion-body">
                                            <div class="row row-cols-1 row-cols-md-2 g-2 slotContainer">
                                                {% for slot in tipo.list %}
                                                <div class="col">
                                                    <div class="card slot-card" data-slot-id="{{ slot.id }}">
                                                        <div class="card-body text-center">
                                                            <h6 class="card-title">{{ slot.hora_inicio|date:"l d \d\e F" }}</h6>
                                                            <p class="card-text mb-0">
                                                                {{ slot.hora_inicio|time:"H:i" }} - {{ slot.hora_final|time:"H:i" }}
                                                            </p>
                                                            <small class="text-muted">{{ slot.taller.nombre_taller }}</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                    <p class="text-muted text-center">No hay horarios disponibles por el momento.</p>
                                {% endfor %}
                            </div>
                        </div>
                        <hr>
                        <button type="submit" class="btn btn-primary">Agendar Cita</button>
                        <a href="{% url 'chofer_dashboard' %}" class="btn btn-secondary">Cancelar</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const accordion = document.getElementById('accordionTipos');
    const hiddenInput = document.getElementById('id_agenda_slot');
    const form = document.getElementById('solicitudForm');

    accordion.addEventListener('click', function(e) {
        const clickedCard = e.target.closest('.slot-card');
        if (!clickedCard) return;

        // Quitar 'active' de TODAS las tarjetas en TODO el acordeón
        accordion.querySelectorAll('.slot-card').forEach(card => {
            card.classList.remove('active');
        });

        // Añadir 'active' a la seleccionada
        clickedCard.classList.add('active');

        // Poner el ID en el campo oculto
        hiddenInput.value = clickedCard.dataset.slotId;
    });

    form.addEventListener('submit', function(e) {
        if (!hiddenInput.value) {
            e.preventDefault(); 
            alert('Por favor, seleccione un horario para continuar.');
        }
    });
});
</script>
{% endblock %}